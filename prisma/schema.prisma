// prisma/schema.prisma
// Prisma v7 — Multi-Tenant School Management System

generator client {
  provider   = "prisma-client-js"
  engineType = "binary"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

// ─────────────────────────────────────────────
// MULTI-TENANCY
// ─────────────────────────────────────────────

model Institution {
  id         String    @id @default(cuid())
  name       String
  slug       String    @unique
  logo       String?
  website    String?
  email      String?
  phone      String?
  address    String?
  city       String?
  country    String?   @default("BD")
  timezone   String    @default("Asia/Dhaka")
  currency   String    @default("BDT")
  plan       Plan      @default(STARTER)
  planExpiry DateTime?
  isActive   Boolean   @default(true)
  createdAt  DateTime  @default(now())
  updatedAt  DateTime  @updatedAt

  // Relations
  users          User[]
  students       Student[]
  teachers       Teacher[]
  classes        Class[]
  subjects       Subject[]
  classRoutineEntries ClassRoutineEntry[]
  primaryExams   PrimaryExam[]
  primaryExamMarks PrimaryExamMark[]
  grades         Grade[]
  attendance     Attendance[]
  feeCategories  FeeCategory[]
  fees           Fee[]
  payments       Payment[]
  events         Event[]
  announcements  Announcement[]
  studentRecords StudentRecord[]
  accessRequests AccessRequest[]
  otpChallenges  PhoneOtpChallenge[]
  settings       InstitutionSettings?

  @@index([slug])
  @@map("institutions")
}

model InstitutionSettings {
  id            String      @id @default(cuid())
  institutionId String      @unique
  institution   Institution @relation(fields: [institutionId], references: [id], onDelete: Cascade)

  // Academic
  academicYear String @default("2024-2025")
  termsPerYear Int    @default(3)
  workingDays  Int[]  @default([1, 2, 3, 4, 5]) // Mon-Fri

  // Notifications
  emailNotifs Boolean @default(true)
  smsNotifs   Boolean @default(false)

  // Fees
  lateFeePercent  Float @default(0)
  gracePeriodDays Int   @default(7)

  // Certificate signatures
  signatoryName      String?
  signatoryTitle     String?
  coSignatoryName    String?
  coSignatoryTitle   String?
  certificateFooter  String?
  certificateLogoUrl String?
  publicReportsEnabled     Boolean @default(false)
  publicReportsDescription String?

  updatedAt DateTime @updatedAt

  @@map("institution_settings")
}

enum Plan {
  STARTER
  PROFESSIONAL
  ENTERPRISE
}

// ─────────────────────────────────────────────
// AUTH (Auth.js v5 compatible)
// ─────────────────────────────────────────────

model User {
  id            String    @id @default(cuid())
  name          String?
  email         String    @unique
  phone         String?   @unique
  emailVerified DateTime?
  image         String?
  password      String?
  role          Role      @default(OFFICE_STAFF)
  approvalStatus ApprovalStatus @default(APPROVED)
  isActive      Boolean   @default(true)
  lastLoginAt   DateTime?
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  institutionId String
  institution   Institution @relation(fields: [institutionId], references: [id], onDelete: Cascade)

  // Auth.js required relations
  accounts Account[]
  sessions Session[]

  // App relations
  teacherProfile Teacher?
  auditLogs      AuditLog[]
  accessRequestsApproved AccessRequest[] @relation("AccessRequestApprovedUser")
  accessRequestsReviewed AccessRequest[] @relation("AccessRequestReviewedBy")
  otpChallenges          PhoneOtpChallenge[]

  @@index([institutionId])
  @@index([email])
  @@map("users")
}

model Account {
  id                String  @id @default(cuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String?
  access_token      String?
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String?
  session_state     String?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
  @@index([userId])
  @@map("accounts")
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@map("sessions")
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
  @@map("verification_tokens")
}

enum Role {
  SUPER_ADMIN
  ADMIN
  PRINCIPAL
  HEAD_TEACHER
  TEACHER
  CLASS_TEACHER
  STAFF
  OFFICE_STAFF
  STUDENT
  PARENT
}

enum ApprovalStatus {
  APPROVED
  PENDING
  REJECTED
}

enum AccessRequestScope {
  TEACHER
  STUDENT
  PARENT
}

enum AccessRequestStatus {
  PENDING
  APPROVED
  REJECTED
}

enum LoginScope {
  ADMIN
  TEACHER
  STUDENT
  PARENT
}

// ─────────────────────────────────────────────
// ACADEMIC STRUCTURE
// ─────────────────────────────────────────────

model Class {
  id           String   @id @default(cuid())
  name         String // "Grade 10A"
  grade        String // "10"
  section      String // "A"
  capacity     Int      @default(30)
  roomNumber   String?
  academicYear String
  isActive     Boolean  @default(true)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  institutionId String
  institution   Institution @relation(fields: [institutionId], references: [id], onDelete: Cascade)

  teacherId    String?
  classTeacher Teacher? @relation("ClassTeacher", fields: [teacherId], references: [id])

  students   Student[]
  timetable  Timetable[]
  routineEntries ClassRoutineEntry[]
  primaryExams PrimaryExam[]
  announcements Announcement[]
  attendance Attendance[]
  fees       Fee[]

  @@unique([institutionId, grade, section, academicYear])
  @@index([institutionId])
  @@map("classes")
}

model Subject {
  id          String   @id @default(cuid())
  name        String
  code        String
  description String?
  credits     Int      @default(1)
  isCore      Boolean  @default(true)
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  institutionId String
  institution   Institution @relation(fields: [institutionId], references: [id], onDelete: Cascade)

  teachers  TeacherSubject[]
  timetable Timetable[]
  grades    Grade[]

  @@unique([institutionId, code])
  @@index([institutionId])
  @@map("subjects")
}

model Timetable {
  id        String   @id @default(cuid())
  dayOfWeek Int // 1=Mon ... 7=Sun
  startTime String // "09:00"
  endTime   String // "10:00"
  createdAt DateTime @default(now())

  classId String
  class   Class  @relation(fields: [classId], references: [id], onDelete: Cascade)

  subjectId String
  subject   Subject @relation(fields: [subjectId], references: [id])

  teacherId String
  teacher   Teacher @relation(fields: [teacherId], references: [id])

  @@index([classId])
  @@index([teacherId])
  @@map("timetables")
}

model ClassRoutineEntry {
  id          String   @id @default(cuid())
  dayOfWeek   Int // 0=Sun ... 4=Thu (Govt Primary weekdays)
  periodNo    Int // 1..6
  subjectName String
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  institutionId String
  institution   Institution @relation(fields: [institutionId], references: [id], onDelete: Cascade)

  classId String
  class   Class  @relation(fields: [classId], references: [id], onDelete: Cascade)

  @@unique([classId, dayOfWeek, periodNo])
  @@index([institutionId, classId])
  @@map("class_routine_entries")
}

model PrimaryExam {
  id           String   @id @default(cuid())
  name         String
  year         Int
  subjectsText String
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  institutionId String
  institution   Institution @relation(fields: [institutionId], references: [id], onDelete: Cascade)

  classId String
  class   Class  @relation(fields: [classId], references: [id], onDelete: Cascade)

  marks PrimaryExamMark[]

  @@index([institutionId, classId, year])
  @@map("primary_exams")
}

model PrimaryExamMark {
  id          String   @id @default(cuid())
  subjectName String
  score       Float?
  isAbsent    Boolean  @default(false)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  institutionId String
  institution   Institution @relation(fields: [institutionId], references: [id], onDelete: Cascade)

  examId String
  exam   PrimaryExam @relation(fields: [examId], references: [id], onDelete: Cascade)

  studentId String
  student   Student @relation(fields: [studentId], references: [id], onDelete: Cascade)

  @@unique([examId, studentId, subjectName])
  @@index([institutionId, examId])
  @@index([studentId])
  @@map("primary_exam_marks")
}

// ─────────────────────────────────────────────
// PEOPLE
// ─────────────────────────────────────────────

model Student {
  id          String    @id @default(cuid())
  studentId   String // Human-readable ID e.g. "STU-2024-001"
  firstName   String
  lastName    String
  studentNameBn String?
  studentNameEn String?
  email       String?
  phone       String?
  dateOfBirth DateTime?
  gender      Gender?
  photo       String?
  guardianName String?
  rollNo      String?
  address     String?
  village     String?
  ward        String?
  upazila     String?
  district    String?
  city        String?
  country     String?
  fatherName  String?
  motherName  String?
  guardianPhone String?
  birthRegNo  String?
  nidNo       String?

  // Academic
  enrollmentDate DateTime      @default(now())
  graduationDate DateTime?
  status         StudentStatus @default(ACTIVE)
  bloodGroup     String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  institutionId String
  institution   Institution @relation(fields: [institutionId], references: [id], onDelete: Cascade)

  classId String?
  class   Class?  @relation(fields: [classId], references: [id])

  // Relations
  parents    Parent[]
  attendance Attendance[]
  grades     Grade[]
  primaryExamMarks PrimaryExamMark[]
  fees       Fee[]
  records    StudentRecord[]

  @@unique([institutionId, studentId])
  @@index([institutionId])
  @@index([classId])
  @@map("students")
}

model Parent {
  id         String  @id @default(cuid())
  firstName  String
  lastName   String
  email      String
  phone      String?
  occupation String?
  relation   String  @default("Parent") // Father, Mother, Guardian

  studentId String
  student   Student @relation(fields: [studentId], references: [id], onDelete: Cascade)

  @@index([studentId])
  @@map("parents")
}

model Teacher {
  id             String         @id @default(cuid())
  teacherId      String // e.g. "TCH-2024-001"
  firstName      String
  lastName       String
  email          String
  phone          String?
  dateOfBirth    DateTime?
  gender         Gender?
  photo          String?
  address        String?
  qualification  String?
  specialization String?
  joiningDate    DateTime       @default(now())
  salary         Decimal?       @db.Decimal(12, 2)
  status         EmployeeStatus @default(ACTIVE)
  createdAt      DateTime       @default(now())
  updatedAt      DateTime       @updatedAt

  institutionId String
  institution   Institution @relation(fields: [institutionId], references: [id], onDelete: Cascade)

  userId String? @unique
  user   User?   @relation(fields: [userId], references: [id])

  // Relations
  subjects     TeacherSubject[]
  classTeacher Class[]          @relation("ClassTeacher")
  timetable    Timetable[]

  @@unique([institutionId, teacherId])
  @@index([institutionId])
  @@map("teachers")
}

model TeacherSubject {
  teacherId String
  subjectId String
  teacher   Teacher @relation(fields: [teacherId], references: [id], onDelete: Cascade)
  subject   Subject @relation(fields: [subjectId], references: [id], onDelete: Cascade)

  @@id([teacherId, subjectId])
  @@map("teacher_subjects")
}

enum Gender {
  MALE
  FEMALE
  OTHER
}

enum StudentStatus {
  ACTIVE
  INACTIVE
  GRADUATED
  SUSPENDED
  EXPELLED
  TRANSFERRED
}

enum EmployeeStatus {
  ACTIVE
  INACTIVE
  ON_LEAVE
  RESIGNED
  TERMINATED
}

// ─────────────────────────────────────────────
// ACADEMICS — GRADES & ATTENDANCE
// ─────────────────────────────────────────────

model Grade {
  id          String   @id @default(cuid())
  score       Float
  maxScore    Float    @default(100)
  percentage  Float
  letterGrade String? // A, B+, etc.
  term        String // "Term 1 2024"
  remarks     String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  institutionId String
  institution   Institution @relation(fields: [institutionId], references: [id], onDelete: Cascade)

  studentId String
  student   Student @relation(fields: [studentId], references: [id], onDelete: Cascade)

  subjectId String
  subject   Subject @relation(fields: [subjectId], references: [id])

  @@index([studentId])
  @@index([institutionId])
  @@map("grades")
}

model Attendance {
  id       String           @id @default(cuid())
  date     DateTime         @db.Date
  status   AttendanceStatus
  remarks  String?
  markedAt DateTime         @default(now())

  institutionId String
  institution   Institution @relation(fields: [institutionId], references: [id], onDelete: Cascade)

  classId String
  class   Class  @relation(fields: [classId], references: [id])

  studentId String
  student   Student @relation(fields: [studentId], references: [id], onDelete: Cascade)

  @@unique([studentId, date])
  @@index([classId, date])
  @@index([institutionId])
  @@map("attendance")
}

enum AttendanceStatus {
  PRESENT
  ABSENT
  LATE
  EXCUSED
  HOLIDAY
}

// ─────────────────────────────────────────────
// FINANCE
// ─────────────────────────────────────────────

model FeeCategory {
  id        String   @id @default(cuid())
  name      String
  feeType   FeeType  @default(MISC)
  isPreset  Boolean  @default(false)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  institutionId String
  institution   Institution @relation(fields: [institutionId], references: [id], onDelete: Cascade)

  @@unique([institutionId, name])
  @@index([institutionId])
  @@map("fee_categories")
}

model Fee {
  id           String    @id @default(cuid())
  title        String // "Tuition Fee — Term 1"
  description  String?
  amount       Decimal   @db.Decimal(12, 2)
  dueDate      DateTime
  term         String
  academicYear String
  feeType      FeeType   @default(TUITION)
  status       FeeStatus @default(UNPAID)
  isRecurring  Boolean   @default(false)
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt

  institutionId String
  institution   Institution @relation(fields: [institutionId], references: [id], onDelete: Cascade)

  studentId String
  student   Student @relation(fields: [studentId], references: [id], onDelete: Cascade)

  classId String?
  class   Class?  @relation(fields: [classId], references: [id])

  payments Payment[]

  @@index([studentId])
  @@index([institutionId])
  @@map("fees")
}

model Payment {
  id             String        @id @default(cuid())
  amount         Decimal       @db.Decimal(12, 2)
  method         PaymentMethod @default(CASH)
  transactionRef String?       @unique
  receiptNumber  String?       @unique
  notes          String?
  paidAt         DateTime      @default(now())
  createdAt      DateTime      @default(now())

  institutionId String
  institution   Institution @relation(fields: [institutionId], references: [id], onDelete: Cascade)

  feeId String
  fee   Fee    @relation(fields: [feeId], references: [id])

  @@index([feeId])
  @@index([institutionId])
  @@map("payments")
}

enum FeeType {
  TUITION
  TRANSPORT
  LIBRARY
  LABORATORY
  SPORTS
  EXAMINATION
  UNIFORM
  MISC
}

enum FeeStatus {
  UNPAID
  PARTIAL
  PAID
  OVERDUE
  WAIVED
}

enum PaymentMethod {
  CASH
  CARD
  BANK_TRANSFER
  CHEQUE
  ONLINE
  STRIPE
}

// ─────────────────────────────────────────────
// COMMUNICATION
// ─────────────────────────────────────────────

model Announcement {
  id             String    @id @default(cuid())
  title          String
  content        String
  priority       Priority  @default(NORMAL)
  targetAudience String[]  @default(["ALL"]) // ALL, STUDENTS, TEACHERS, PARENTS
  publishedAt    DateTime  @default(now())
  expiresAt      DateTime?
  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt

  institutionId String
  institution   Institution @relation(fields: [institutionId], references: [id], onDelete: Cascade)
  classId       String?
  class         Class?     @relation(fields: [classId], references: [id], onDelete: SetNull)

  @@index([institutionId])
  @@index([classId])
  @@map("announcements")
}

model Event {
  id          String    @id @default(cuid())
  title       String
  description String?
  startDate   DateTime
  endDate     DateTime?
  location    String?
  type        EventType @default(GENERAL)
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  institutionId String
  institution   Institution @relation(fields: [institutionId], references: [id], onDelete: Cascade)

  @@index([institutionId])
  @@map("events")
}

enum Priority {
  LOW
  NORMAL
  HIGH
  URGENT
}

enum EventType {
  ACADEMIC
  SPORTS
  CULTURAL
  HOLIDAY
  EXAM
  GENERAL
}

enum RecordPeriodType {
  WEEKLY
  MONTHLY
  QUARTERLY
  ANNUAL
  CUSTOM
}

enum StudentRecordType {
  ID_CARD
  RESULT_SHEET
  ATTENDANCE_RECORD
  BEHAVIOR_TRACKING
  FINAL_EXAM_CERTIFICATE
  CHARACTER_CERTIFICATE
  EXTRA_SKILLS_CERTIFICATE
  TRANSFER_CERTIFICATE
  WEEKLY_PROGRESS
  MONTHLY_PROGRESS
  QUARTERLY_PROGRESS
  ANNUAL_FINAL_REPORT
}

enum RecordSource {
  MANUAL
  CRON
}

model StudentRecord {
  id                String            @id @default(cuid())
  title             String
  fileName          String
  fileUrl           String
  periodType        RecordPeriodType
  periodLabel       String
  recordType        StudentRecordType
  source            RecordSource      @default(MANUAL)
  generatedByUserId String?
  generatedAt       DateTime          @default(now())
  metadata          Json?
  createdAt         DateTime          @default(now())
  updatedAt         DateTime          @updatedAt

  institutionId String
  institution   Institution @relation(fields: [institutionId], references: [id], onDelete: Cascade)

  studentId String
  student   Student @relation(fields: [studentId], references: [id], onDelete: Cascade)

  @@unique([studentId, periodType, periodLabel, recordType])
  @@index([institutionId, studentId])
  @@index([periodType, periodLabel])
  @@map("student_records")
}

model AccessRequest {
  id              String             @id @default(cuid())
  institutionId   String
  institution     Institution        @relation(fields: [institutionId], references: [id], onDelete: Cascade)
  requestedScope  AccessRequestScope
  status          AccessRequestStatus @default(PENDING)
  fullName        String
  email           String?
  phone           String?
  passwordHash    String
  rejectionReason String?
  metadata        Json?
  requestedAt     DateTime           @default(now())
  reviewedAt      DateTime?
  approvedUserId  String?
  approvedUser    User?              @relation("AccessRequestApprovedUser", fields: [approvedUserId], references: [id])
  reviewedByUserId String?
  reviewedByUser   User?             @relation("AccessRequestReviewedBy", fields: [reviewedByUserId], references: [id])
  createdAt       DateTime           @default(now())
  updatedAt       DateTime           @updatedAt

  @@index([institutionId, status, requestedScope])
  @@index([email])
  @@index([phone])
  @@map("access_requests")
}

model PhoneOtpChallenge {
  id            String      @id @default(cuid())
  institutionId String
  institution   Institution @relation(fields: [institutionId], references: [id], onDelete: Cascade)
  userId        String?
  user          User?       @relation(fields: [userId], references: [id], onDelete: SetNull)
  scope         LoginScope
  phone         String
  twilioSid     String?
  codeHash      String
  attempts      Int         @default(0)
  maxAttempts   Int         @default(5)
  expiresAt     DateTime
  resendAfter   DateTime?
  consumedAt    DateTime?
  createdAt     DateTime    @default(now())
  updatedAt     DateTime    @updatedAt

  @@index([institutionId, phone, createdAt])
  @@index([userId])
  @@map("phone_otp_challenges")
}

// ─────────────────────────────────────────────
// AUDIT
// ─────────────────────────────────────────────

model AuditLog {
  id        String   @id @default(cuid())
  action    String
  entity    String
  entityId  String
  oldValues Json?
  newValues Json?
  ipAddress String?
  userAgent String?
  createdAt DateTime @default(now())

  userId String
  user   User   @relation(fields: [userId], references: [id])

  @@index([userId])
  @@index([entity, entityId])
  @@map("audit_logs")
}
